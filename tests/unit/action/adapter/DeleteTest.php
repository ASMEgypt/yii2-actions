<?php
/**
 * User: execut
 * Date: 25.07.16
 * Time: 9:59
 */

namespace execut\actions\action\adapter;


use execut\actions\TestCase;
use yii\db\ActiveRecord;
use yii\helpers\Url;
use yii\web\Request;
use yii\web\Response;

class DeleteTest extends TestCase
{
    public function setUp()
    {
        parent::setUp(); // TODO: Change the autogenerated stub
        $_SERVER['HTTP_REFERER'] = 'test';
    }

    public function tearDown()
    {
        parent::tearDown(); // TODO: Change the autogenerated stub
        $_SERVER['HTTP_REFERER'] = null;
    }

    public function testRun() {
        $action = new Delete();
        \yii::$app->layout = 'test';
        $action->modelClass = DeleteTestModel::className();
        $action->setActionParams([
            'get' => [
                'id' => 1,
            ],
            'module' => 'testModule',
            'controller' => 'testController',
            'action' => 'testAction'
        ]);

        $response = $action->run();

        $this->assertInstanceOf(Response::className(), $response->content);
        $this->assertEquals('test', $response->content->getHeaders()->get('Location'));

        $model = $action->model;
        $this->assertTrue($model->isDeleteCalled);
        $this->assertEquals(1, $model->pk);

        $this->assertEquals([
            'kv-detail-success' => 'Record #' . $model->id . ' is successfully deleted',
        ], $response->flashes);
    }
}

class DeleteTestModel extends ActiveRecord {
    public $isDeleteCalled = false;
    public $pk = null;
    public $id = 1;
    public $primaryKey = 1;

    public static function primaryKey()
    {
        return 'id';
    }

    public static function find() {
        $model = new self;

        return $model;
    }

    public function andWhere($where) {
        $this->pk = $where['id'];
        return $this;
    }

    public function one() {
        return $this;
    }

    public function delete()
    {
        return $this->isDeleteCalled = true;
    }

    public function __toString()
    {
        return 'deletedModel';
    }
}